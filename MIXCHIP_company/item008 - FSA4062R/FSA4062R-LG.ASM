;8M
CHIP	SN8P2604A
//{{SONIX_CODE_OPTION
	.Code_Option	Noise_Filter	Enable
	.Code_Option	Reset_Pin	P02
	.Code_Option	Watch_Dog	Enable		; Normal mode: Enable Watchdog Green and Sleep mode: Stop Watchdog
	.Code_Option	High_Clk	4M_X'tal	; Crystal/Resonator: 2Mhz~10Mhz
	.Code_Option	Fcpu		#2     ; Fcpu = Fosc/4
	.Code_Option	Security	Enable
	.Code_Option	LVD		LVD_H		; 2.4V Reset Enable LVD36 bit of PFLAG for 3.6V Low Voltage Indicator
//}}SONIX_CODE_OPTION
.NOLIST
	INCLUDESTD	macro1.h
	INCLUDESTD	macro2.h
	INCLUDESTD	macro3.h
.LIST
;========general purpose register====;0X00--0X7F TATOL 128 BYTE RAM
.DATA
	ORG		0X00
acc_bak     	DS	1
status_bak     	DS	1
FLAG1		DS	1
PRO_F		EQU	FLAG1.0
BZON_F		EQU	FLAG1.1
ONF_F		EQU	FLAG1.2
KRELAX_F	EQU	FLAG1.3
ONFKRELAX_F	EQU	FLAG1.4
FINISH_F	EQU	FLAG1.5
HL_F		EQU	FLAG1.6
IRK_B		EQU	FLAG1.7

FLAG2		DS	1
DIVFINISH_F	EQU	FLAG2.0
POWERON_F	EQU	FLAG2.1
TMSET_F		EQU	FLAG2.2
KEYIN_F		EQU	FLAG2.3
NOBZ_F		EQU	FLAG2.4
DEFINE_F	EQU	FLAG2.5
DPOFF_F		EQU	FLAG2.6
ADFINISH_B	EQU	FLAG2.7

FLAG3	DS	1
DS_TM1S_F		EQU	FLAG3.0
NAT_TM1S_F		EQU	FLAG3.1
SLP_TM1S_F		EQU	FLAG3.2
CHKSPACE_TM1S_F		EQU	FLAG3.3
KP3S_F		EQU	FLAG3.4
HEXGT100_F		EQU	FLAG3.5
TMTEST_F		EQU	FLAG3.6
DPTMDOT_F		EQU	FLAG3.7

FLAG4		DS	1
KEYHAVE_F	EQU	FLAG4.0
TM2ONE0_F	EQU	FLAG4.1
TM2OFFE0_F	EQU	FLAG4.2
MOTONF_F	EQU	FLAG4.3
FOHL_F		EQU	FLAG4.4
FOLT_F		EQU	FLAG4.5
FOGT_F		EQU	FLAG4.6
DPON_F		EQU	FLAG4.7

FLAG5		DS	1
VRSPIN_F	EQU	FLAG5.0
NATUPDN_F	EQU	FLAG5.1

INT_CNT		DS	1
t_20ms		DS	1
MAIN_CNT	DS	1

TEMP_CHK	DS	1
;LED_DIG		DS	1

SW			DS	1
;ION			DS	1

DATA_BUF	DS	1
HEXD		DS	1
DECD		DS	1
TM_DIG		DS	1
DP_MODE	DS	1
DP_TM		DS	1

SPEED		DS	1
SPEED_OUT	DS	1
SPEED_DP	DS	1
KEYV_NEW	DS	1
KEYV_OLD	DS	1
TMK_B		EQU	2
SWK_B		EQU	4
MODEK_B		EQU	5
ONFK_B		EQU	7

KP_TM		DS	1

MODE		DS	1
TM_STEP		DS	1
BZ_MODE	DS	1
BZ_TM		DS     1

TM_10MS	DS	1
TM_1S		DS	1
TM_1MIN		DS	1
TM_MIN2OFF	DS	1
TM_MIN2ON	DS	1
TM_HOUR2OFF	DS	1
TM_HOUR2ON	DS	1
TM_MIN_BUF	DS	1
TM_HOUR_BUF	DS	1

LEDFLASH_STEP	DS	1
LEDFLASH_TM	DS	1

PULSE		DS	1
L_CNT1		DS	1
H_CNT1		DS	1
DATALP_CNT	DS	1
DATAL		DS	1
DATAH		DS	1
B_CNT1		DS	1
DATAL2		DS	1
DATAH2		DS	1
DATAL3		DS	1
DATAH3		DS	1
IRPRESS_TM	DS	1
IR_DATAL_BUF	DS	1

CHARGE_CNT1	DS	1
DISC2RT_CNT1	DS	1
DISC2RT_CNT2	DS	1
DISC2RS_CNT	DS	1
CHK_STEP	DS	1

DISC2RT_CNT1_BUF	DS	1

DISC2RT_CNT2_BUF	DS	1
DISC2RS_CNT_BUF		DS	1
CHARGE_CNT2		DS	1

VAL00		DS	1
VAL01		DS	1
VAL02		DS	1
VAL03		DS	1
VAL03_BUF	DS	1
;CHKSPACE_TM1S	DS	1
CHKSPACE_TMNS	DS	1
ADP_STEP	DS	1
ADP_PC		DS	1
ADP_CNT		DS	1

TEMPCHANGE_STEP	DS	1
NTDATA_BUF	DS	1
TEMPLT_CNT	DS	1
TEMPGT_CNT	DS	1
TEMPEQU_CNT	DS	1
CHK_TEMP_BUF1	DS	1
CHK_TEMP_BUF2	DS	1

LEDTX_BIT		DS	1
COMMAND_MODE	DS	1
COMMAND_DATA		DS	1
COMMAND_ADDRESS	DS	1
COMMAND_BUF		DS	1
LEDP_CNT	DS	1

KEY_CNT		DS	1
TM_HOUR		DS	1
TM_MIN		DS	1
PWMD_AUTO	DS	1
;AIMODE_STEP	DS	1

FOCHK_CNTL	DS	1
FOCHK_CNTH	DS	1
FOCHK_TM	DS	1
FOCHKNO_CNT	DS	1

NTC_ERR		DS	1

PWMC		DS		1
PWMD		DS		1
PWMC_TM	DS	1
PWM_S0D	DS	1
PWMD_BUF	DS	1

NATURE_SPEED	DS	1
SPEED_AUTO		DS	1
NATURE_STEP	DS	1
NATURE_TM1S	DS	1
NATURE_TMNS	DS	1
;SLP_TM1S		DS	1
SLP_TM1MIN		DS	1
SLP_TMNMIN		DS	1
;SP_BUFH			DS		1
;SP_BUFL				DS		1
;SLP_STEP		DS		1
;testd	ds	1

;DEL_CNT		DS	1

VR_IN		DS	1
VR_OLD		DS	1
VR_IN_F		DS	1		;B0=1,SP UP,B1=1,SP DOWN
VR_TM		DS	1
VR_NOCHANGE_TM	DS	1
VR_UP_CNT	DS	1
VR_DN_CNT	DS	1

;0X7F END
;****************************
LEDSTB_B	EQU	P1.0
LEDCLK_B	EQU	P1.1
LEDDATA_B	EQU	P1.2

IRIN_B		EQU	P0.2
FOIN_B		EQU	P0.1

BZOUT_B		EQU	P5.2

SWOUT_B		EQU	P5.4

CHKINPM_B	EQU		P0M.0
CHKINP_B	EQU		P0.0
RSM_B		EQU		P5M.1
RS_B		EQU		P5.1
RTM_B		EQU		P5M.0
RT_B		EQU		P5.0


;POWERDNC_B	EQU	P5.2		;P1.1
;****************************
AA_B	EQU	0
BB_B	EQU	1
CC_B	EQU	2
DD_B	EQU	3
EE_B	EQU	4
FF_B	EQU	5
GG_B	EQU	6
HH_B	EQU	7

;****************************
V_TM1S	EQU	64

V_TM1MIN	EQU	60
V_PWMD_MAX	EQU	28

V_T0C			EQU	256-125	;60
V_TC1R			EQU	256-128
V_TC1R120US		EQU	135	;195	;135
V_TC1R140US		EQU	115	;186	;115
V_TC1R160US		EQU	95	;176	;95

USERID		EQU	0FH
V_PWMC_TM	EQU	25
;****************************
TMCLRP	MACRO
	CLR		TM_1MIN
	CLR		TM_MIN2OFF
	CLR		TM_MIN2ON
	CLR		TM_HOUR2OFF
	CLR		TM_HOUR2ON	
        ENDM
        
;****************************
MOVCMP	MACRO
	B0ADD	Z,A
	B0BTS1	FC
	JMP		$+2
	INCMS	Y
	NOP
	MOVC	
	ENDM	
        
;****************************
;==================interrupt  ====================
.CODE
	org  000h                                           
	JMP    start                                       
	JMP    start                                       
	JMP    start                                       
	JMP    start                                       
	org  008h                                               
   	JMP    interrupt                                                                                                
interrupt:                                                                          
    XCH	   A,ACC_BAK
    MOV	   A,PFLAG 
    MOV	   STATUS_BAK,A

    MOV    a,#V_T0C		;256-60;60                    ;                  	
    MOV    t0c,a                        ;                   
    CLR    INTRQ                          ;125US                   

    INCMS    t_20ms
     NOP            
    MOV    a,t_20ms                                    
    ADD    a,#256-78		                              		        
    BTS1    FC                                           
    JMP      TCC_OUT                                     
    CLR    t_20ms                      
    BSET    PRO_F               ; 10MS                  
TCC_OUT: 
	BTS1	BZON_F
	JMP		TCC_OUT1
	MOV		A,#04H
	XOR		P5,A		
	JMP		TCC_OUT2
TCC_OUT1:
	BCLR	BZOUT_B	
TCC_OUT2:
	INCMS	INT_CNT
	NOP
	BTS0	INT_CNT.0
    	CALL	IR_CHK                  ;
    CALL	CHKP
	CALL	FO_CHKP
    CALL	TM1SP
    CALL	CHK_VR
   MOV	    A,STATUS_BAK
    MOV	   PFLAG,A
    XCH	   A,ACC_BAK
    RETI                                ;                  
;************************
LCD_TABLE1:
	DW	003FH   ;0
	DW	0006H	;1
	DW	005BH	;2
	DW	004FH	;3
	DW	0066H	;4
	DW	006DH	;5
	DW	007DH	;6
	DW	0007H	;7
	DW	007FH	;8
	DW	006FH	;9  
	DW	0000H	;A
	DW	0000H	;B
	DW	0039H	;C
	DW	005EH	;D
	DW	0077H	;E		;A
	DW	0071H	;F	  	;F
;************************
ADGT10C_TABLE1:
	DW	0C9H		;0
	DW	0BFH		;1
	DW	0B5H		;2
	DW	0ABH		;3
	DW	9FH		;4
	DW	98H		;5
	DW	91H		;6
	DW	8AH		;7
	DW	83H		;8
	DW	7CH		;9    
	DW	78H		;10   
	DW	74H		;11
	DW	70H		;12
	DW	6AH		;13
	DW	64H		;14
	DW	60H		;15
	DW	5CH		;16
	DW	58H		;17
	DW	54H		;18
	DW	4EH		;19
	DW	4CH		;20
	DW	4AH		;21
	DW	48H		;22
	DW	44H		;23
	DW	40H		;24
	DW	3EH		;25
	DW	3CH		;26
	DW	3AH		;27
	DW	37H		;28
	DW	34H		;29
	DW	32H		;30
	DW	30H		;31
	DW	2EH		;32
	DW	2CH		;33
	DW	2AH		;34
	DW	28H		;35
	DW	26H		;36
	DW	24H		;37
	DW	22H		;38
	DW	20H		;39
	DW	00H		;END
;************************
AITEMP_TABLE:
	DW	20
	DW	23
	DW	26
	DW	29
	DW	32
	DW	35
	DW	0FFH
		
;************************
SP_TABLE1:		;0-63
	DW	3		 ;0
	DW	4		;1
	DW	5		;2
	DW	6		;3
	DW	7		;4
	DW	8		;5
	DW	9		;6
	DW	10		;7
	DW	11		;8
	DW	12		;9   
	DW	13		;10 
	DW	14		 ;11
	DW	15		;12
	DW	16		;13
	DW	17		;14
	DW	18		;15
	DW	19		;16
	DW	20		;17
	DW	21		;18
	DW	22		;19
	DW	23		;20 
	DW	24		;21 
	DW	25			 ;22
	DW	26			;23
	DW	27			;24
/*	DW	34			;25
	DW	34			;26
	DW	35			;27
	DW	36		;28
	DW	37		;29
	DW	38		;30
	DW	39		;31 
	DW	39		;32 
*/	
;************************
TYPE_TABLE1:
	DW	81H		;TYPE	;0
	DW	6FH		;USER ID	;1
	DW	46H		;F		;2
	DW	53H		;S		;3
	DW	41H		;A		;4
	DW	34H		;4		;5
	DW	30H		;0		;6
	DW	39H		;9		;7
	DW	38H		;8		;8
	DW	52H		;R		;9
	DW	49H		;I		;10
	DW	7FH		;		;11
	DW	74H		;		;12
	DW	74H				;13
	DW	50H				;14
	DW	00H				;15	
	DW	00H		;END
;************************
TXCMD_TABLE1:
	DW	81H		;0	;TYPE
	DW	82H		;1	;WORK
	DW	85H		;2	;READ

;************************
DF_TABLE1:
	DW	7DH		;0
	DW	0A5H	;1
	DW	7DH		;2
	DW	55H		;3
	DW	7DH		;4
	DW	0A5H	;5
	DW	7DH		;6
	DW	00H		;7
	DW	00H		;8
;************************
NATS0_TABLE:
	DW	6
	DW	9
	DW	12
	DW	14
	DW	16
	DW	16

;************************
NATUREP_NAT_SPUP_TABLE:
	DW	10
	DW	15
	DW	19
	DW	21
	DW	24
;************************
NATUREP_NAT_SPDN_TABLE:
	DW	3
	DW	4
	DW	5
	DW	7
	DW	8
;************************
FOD_TABLE:			;2.5S
	DW	1*12*25/10
	DW	760*12*25/600	
	DW	0FFH
	
	
;=====================initial===================                   
start:                                  ;start:   
    B0BCLR FGIE                  ;DIS GLOBE INT                
   @RST_WDT                            ;  
/*WAIT_100MS:
	MOV	A,#100
	MOV	TM_100MS,A	
WAIT_1MS:	
   @RST_WDT                            ;  
	MOV	A,#100
	MOV	TM_1MS,A
WAIT_10US:
	NOP
	NOP
	NOP
	NOP
	NOP
	NOP
	NOP
	NOP
	NOP
	NOP
	DECMS	TM_1MS
	JMP	WAIT_10US
	DECMS	TM_100MS
	JMP		WAIT_1MS	
*/		
    @RST_WDT   
    MOV    A,#7FH
    MOV    STKP,A
    MOV    A,#00H
    MOV    OSCM,A
    MOV    INTEN,A
    MOV    INTRQ,A  

    B0MOV  Y,#00H
    B0MOV  Z,#7FH
CLRRAM:
    CLR    @YZ
    DECMS   Z
    JMP    CLRRAM
    CLR    @YZ
;****************************        
    MOV	   A,#00H
    MOV	   P0,A	
    MOV	   A,#00H
    MOV	   P0M,A	       ;P0.0-0.1 OUTP
    MOV	   A,#00H
    MOV	   P0,A	
    mov	a,#00H
    mov	p0ur,a		;DIS P0 PUH
        		
    MOV	   A,#07H
    MOV    P1,A
    MOV	   A,#87H
    MOV    P1M,A		
    MOV	   A,#07H
    MOV    P1,A
    MOV	A,#78H
    MOV	P1UR,A    
    
    MOV	   A,#00H
    MOV    P2,A
    MOV	A,#00H		;BFH
    MOV	P2M,A
    MOV	   A,#00H
    MOV    P2,A
    MOV	A,#0FFH		;40H
    MOV	P2UR,A    
    
    MOV	   A,#13H		;04H
    MOV	   P5,A
    MOV	   A,#1FH
    MOV    P5M,A		;P5.0-4 OUTP
    MOV	   A,#13H		;04H
    MOV	   P5,A
    MOV	A,#00H
    MOV	P5UR,A		;DIS P5 PH
    
    MOV	A,#0
    MOV	P1OC,A		;DIS P1.0-1.1 OPEN DRAIN    	
    mov	a,#074H
    B0MOV	TC1M,A		;PWM BZ 
    
    MOV	A,#V_TC1R140US
    B0MOV	TC1C,A
    B0MOV	TC1R,A
    
;    B0BCLR	FTC1OUT		;P5.3 AS I/O
;    B0BSET	FALOAD1
;    B0BSET	FTC1ENB
	BCLR	P5.3

	MOV	A,#0FFH
	MOV	KEYV_NEW,A

    MOV    a,#V_T0C			;256-60                                      	
    MOV    t0c,a                                          

    MOV	   A,#0F0H
    MOV    T0M,A		;EN T0,FCPU/2

;	MOV	A,#23
;	MOV	TEMP_SET,A
	MOV	A,#0AAH
	MOV	TEMP_CHK,A
	MOV	A,#50
	MOV	CHKSPACE_TMNS,A
;	MOV	A,#20
;	MOV	MAIN_CNT,A
	BSET	KRELAX_F
	MOV		A,#10
	MOV		LEDP_CNT,A	

    BSET   FT0IEN		;EN T0
    NOP
    B0BSET FGIE                  ;EN GLOBE INT      

	MOV		A,#11
	MOV		SPEED,A
	B0MOV	Y,#SP_TABLE1$M
	B0MOV	Z,#SP_TABLE1$L
	MOV		A,#0					;SPEED_OUT
;	AND		A,#0FH
;	B0ADD	Z,A
;	MOVC	
	MOVCMP
	MOV		PWMC,A
	MOV		PWM_S0D,A

	BSET	KEYIN_F								
;**************************;TEST
START2:
    BTS1    PRO_F                             
    JMP   START2                            
    BCLR    PRO_F               ;10MS  
   @RST_WDT                            ;  
	CALL	KEYP
	MOV	A,KEY_CNT
	SUB	A,#3
	BTS1	FC
	JMP	START2
	MOV	A,KEYV_NEW
	XOR	A,#0CFH
	BTS1	FZ
	JMP	START3
	BSET	TMTEST_F
	CALL	KEYP_BZPM1
START3:	
;**************************
MAIN:                                        
    BTS1    PRO_F                             
    JMP    MAIN                             
    BCLR    PRO_F               ;10MS  
    CALL	LEDP
/*    	INCMS	MAIN_CNT
   	NOP
   	MOV		A,MAIN_CNT
   	SUB		A,#6
   	BTS1	FC
   	JMP		MAIN3
	CLR		MAIN_CNT
*/	
   @RST_WDT                            ;  
	CALL	TME0_CHKP
     CALL	IR_PROCESS
     CALL	VR_SPK
     CALL	VR_TMP
     CALL	KEYP
     CALL	BZP
      CALL	NATUREP
      CALL	AI_MODEP	
     CALL	TM_DNP
     CALL	OUTP
      CALL	FOINP
MAIN1:          
     BTS1	CHKSPACE_TM1S_F
     JMP	MAIN2
     BCLR		CHKSPACE_TM1S_F	
     INCMS	CHKSPACE_TMNS
     NOP
     MOV		A,CHKSPACE_TMNS
     SUB		A,#5		;30
     BTS1	FC
     JMP	MAIN2
     MOV	A,#50
     MOV	CHKSPACE_TMNS,A
    JMP    MAIN2               ;                 
MAIN2:						;10MS
     CALL	ADP
    JMP    MAIN                                   
;******************************************
TME0_CHKP:
	BCLR	TM2ONE0_F
	MOV		A,TM_MIN2ON
	BTS1	FZ
	BSET	TM2ONE0_F
	MOV		A,TM_HOUR2ON
	BTS1	FZ
	BSET	TM2ONE0_F

	BCLR	TM2OFFE0_F
	MOV		A,TM_MIN2OFF
	BTS1	FZ
	BSET	TM2OFFE0_F
	MOV		A,TM_HOUR2OFF
	BTS1	FZ
	BSET	TM2OFFE0_F
	
	BCLR	DPON_F
	BTS0	ONF_F
	BSET	DPON_F
	BTS0	TM2ONE0_F
	BSET	DPON_F
	BTS0	TMSET_F
	BSET	DPON_F	
	RET	
;**************************	
BZP:
	INCMS	BZ_TM
	NOP
	MOV		A,BZ_MODE
	XOR		A,#1
	BTS0	FZ
	JMP		BZP1	
	MOV		A,BZ_MODE
	XOR		A,#2
	BTS0	FZ
	JMP		BZP2	
	MOV		A,BZ_MODE
	XOR		A,#3
	BTS0	FZ
	JMP		BZP3	
BZP_OFF:
	CLR		BZ_MODE
	CLR		BZ_TM
BZP_OFF1:
	BCLR	BZON_F
;	MOV		A,#74H
;	MOV		TC0M,A
	RET					
BZP_ON:
;	MOV		A,#0F6H
;	MOV		TC0M,A
	BSET	BZON_F
	RET
BZP1:
	MOV		A,BZ_TM
	SUB		A,#14
	BTS1	FC
	JMP		BZP_ON
	JMP		BZP_OFF	
	
BZP2:						;KAIJI
	MOV		A,BZ_TM
	SUB		A,#14
	BTS1	FC
	JMP		BZP_ON
;	INCMS	BZ_TM
;	NOP
	MOV		A,BZ_TM
	SUB		A,#19
	BTS1	FC
	JMP		BZP_OFF1
;	INCMS	BZ_TM
;	NOP
	MOV		A,BZ_TM
	SUB		A,#33
	BTS1	FC
	JMP		BZP_ON
	JMP		BZP_OFF	
BZP3:					;GUANJI
	MOV		A,BZ_TM
	SUB		A,#33
	BTS1	FC
	JMP		BZP_ON
	JMP		BZP_OFF		
;**************************	
OUTP:
	BTS1	ONF_F
	JMP		OUTP_OFF
OUTP_SW:
	BTS0	SW.0
	JMP		OUTP_SW_ON
OUTP_SW_OFF:
	BSET	SWOUT_B
	JMP		OUTP_ION
OUTP_SW_ON:
	MOV		A,MODE
	XOR		A,#3
	BTS1	FZ
	JMP		OUTP_SW_ON1
	BTS0	MOTONF_F
	JMP		OUTP_SW_ON1
;	MOV		A,PWMD_AUTO
;	BTS0	FZ
	JMP		OUTP_SW_OFF		;AI MODE, MOT OFF
OUTP_SW_ON1:	
	BCLR	SWOUT_B	
OUTP_ION:
OUTP_SP:
	MOV		A,SPEED
	MOV		SPEED_OUT,A	
	MOV		A,MODE
	BTS0	FZ
	JMP		OUTP_SP1
	DECS	SPEED_AUTO
	NOP
	MOV	SPEED_OUT,A
OUTP_SP1:	
	MOV		A,SPEED_OUT
	SUB		A,#24
	BTS0	FC
	JMP		OUTP_OFF
	B0MOV	Y,#SP_TABLE1$M
	B0MOV	Z,#SP_TABLE1$L
	MOV	 A,SPEED_OUT
;	AND		A,#0FH
;	B0ADD	Z,A
	MOVCMP	
	MOV		PWMD,A	  
OUTP_SP2:	
	BTS1	FOLT_F
	JMP	OUTP_SP22	
	B0MOV	Y,#SP_TABLE1$M
	B0MOV	Z,#SP_TABLE1$L
	MOV	A,#2			;SPEED_OUT
	MOVCMP
	MOV	DATA_BUF,A
	MOV	A,PWMD
	SUB	A,DATA_BUF
	BTS0	FC
	JMP	OUTP_SP23
	MOV	A,DATA_BUF
	MOV	PWMD,A
	JMP	OUTP_SP23
OUTP_SP22:
	BTS1	FOGT_F
	JMP	OUTP_SP23	
	MOV	A,PWMD
	SUB	A,PWMD_BUF
	BTS1	FC
	JMP	OUTP_SP23
	MOV	A,PWMD_BUF
	MOV	PWMD,A	
OUTP_SP23:		
	INCMS	PWMC_TM
	NOP
	MOV		A,PWMC_TM
	SUB		A,#V_PWMC_TM	;15		;10
	BTS1	FC
	JMP		OUTP_MOTP_ON12
	CLR		PWMC_TM				;100MS
	MOV		A,PWMC
	SUB		A,PWMD			;#V_PWMD
	BTS0	FC
	JMP		OUTP_MOTP_ON11
	INCMS	PWMC
	NOP		
	JMP		OUTP_MOTP_ON12
OUTP_MOTP_ON11:	
	BTS0	FZ
	JMP		OUTP_MOTP_ON12		;=
	DECMS	PWMC
	NOP	
OUTP_MOTP_ON12:		
;	BSET	POWERDN_B			;POWER ON
	BSET	MOTONF_F			;MOT ON
	MOV		A,PWMC	;#V_PWMD			;12
	MOV		TC1R,A
	MOV		A,#0F3H		;0-63 ;;15K  ;FCPU=2M
	MOV		TC1M,A	
	RET
OUTP_OFF:
	BSET	SWOUT_B
OUTP_OFF2:	
	MOV		A,PWM_S0D
	SUB		A,PWMC		;#1		;62
	BTS0	FC
	JMP		OUTP_OFF3		
	INCMS	PWMC_TM
	NOP
	MOV		A,PWMC_TM
	SUB		A,#V_PWMC_TM	;15		;10
	BTS1	FC
	JMP		OUTP_MOTP_ON12
	CLR		PWMC_TM
	DECMS	PWMC
	NOP
	JMP		OUTP_MOTP_ON12	
OUTP_OFF3:
	MOV		A,#70H
	MOV		TC1M,A	
	BCLR	P5.3
;	BCLR	POWERDN_B			;POWER OFF
	BCLR	MOTONF_F			;MOT OFF	
	RET
	
;*************************************	
;**************************	
FO_CHKP:			;125US
	BTS0	FOIN_B
	JMP	FO_CHKPH
	BTS1	FOHL_F
	RET
	BCLR	FOHL_F
	JMP	FO_CHKP_IN
FO_CHKPH:
	BTS0	FOHL_F
	RET
	BSET	FOHL_F
	RET
FO_CHKP_IN:
	INCMS	FOCHK_CNTL
	RET				;/=0
	INCMS	FOCHK_CNTH
	RET
	MOV	A,#0FFH
	MOV	FOCHK_CNTH,A
	RET	
;***********************************************
FOINP:					;10MS
	BTS0	ONF_F
	JMP	FOINP_ON
	BCLR	FOLT_F
	BCLR	FOGT_F
	CLR	FOCHK_TM
	CLR	FOCHKNO_CNT
FOINP01:	
	CLR	FOCHK_CNTL
	CLR	FOCHK_CNTH
	RET
FOINP_ON:
	INCMS	FOCHK_TM
	NOP
	MOV	A,FOCHK_TM
	SUB	A,#250
	BTS1	FC
	RET
	CLR	FOCHK_TM
	B0MOV	Y,#FOD_TABLE$M
	B0MOV	Z,#FOD_TABLE$L
	MOV	A,#0
;	B0ADD	Z,A
;	MOVC	
	MOVCMP
	MOV	DATA_BUF,A

	MOV		A,FOCHK_CNTL	
	SUB		A,DATA_BUF
	MOV		A,FOCHK_CNTH		
	SBC		A,R
	BTS0	FC
	JMP	FOINP_ON_GT1		;>=
FOINP_ON_LT:			;SP NO TURN
	INCMS	FOCHKNO_CNT
	NOP
	MOV	A,FOCHKNO_CNT
	SUB	A,#600/25		;60S/2.5S
	BTS1	FC	
	JMP	FOINP_ON_LT1
	CLR	FOCHKNO_CNT
	JMP	KEYP_TOOFF
FOINP_ON_LT1:			
	BCLR	FOGT_F
	BSET	FOLT_F	
	JMP	FOINP01
FOINP_ON_GT1:	
	CLR	FOCHKNO_CNT	
	B0MOV	Y,#FOD_TABLE$M
	B0MOV	Z,#FOD_TABLE$L
	MOV	A,#1
;	B0ADD	Z,A
;	MOVC	
	MOVCMP
	MOV	DATA_BUF,A

	MOV	A,FOCHK_CNTL	
	SUB	A,DATA_BUF
	MOV	A,FOCHK_CNTH		
	SBC	A,R
	BTS1	FC
	JMP	FOINP_OK			;SP OK
FOINP_ON_GT2:		
;	BTS0	FOGT_F
	BCLR	FOLT_F
	BSET	FOGT_F
	MOV	A,PWMD
	MOV	PWMD_BUF,A
	DECMS	PWMD_BUF
	NOP
	JMP	FOINP01
FOINP_OK:
	BCLR	FOLT_F
	BCLR	FOGT_F
	JMP	FOINP01

;************************
TM1SP:
	INCMS	TM_10MS
	NOP
	MOV		A,TM_10MS
	SUB		A,#80
	BTS1	FC
	RET
	CLR		TM_10MS
	INCMS	TM_1S
	NOP
	MOV		A,TM_1S
	SUB		A,#95			;100
	BTS1	FC		
	RET
	CLR		TM_1S
	BSET	DS_TM1S_F	
	BSET	NAT_TM1S_F	
	BSET	SLP_TM1S_F	
	BSET	CHKSPACE_TM1S_F
	RET
;************************
TM_DNP:
	BTS1	DS_TM1S_F
	RET	
	BCLR	DS_TM1S_F
	BTS0	TMTEST_F
	JMP	TM_DNP01
	INCMS	TM_1MIN
	NOP
	MOV	A,TM_1MIN
	SUB	A,#V_TM1MIN		;60
	BTS1	FC
	RET
	CLR	TM_1MIN
TM_DNP01:	
	BTS1	ONF_F
	JMP		TM_DNP2ONP
TM_DNP2OFFP:	
	BTS1	TM2OFFE0_F			;/=0
	RET
	MOV		A,TM_MIN2OFF
	BTS0	FZ
	JMP		TM_DNP2OFFP2
	DECMS	TM_MIN2OFF
	RET
	MOV		A,TM_HOUR2OFF
	BTS1	FZ
	RET
	BSET	NOBZ_F
	JMP		KEYP_TOOFF_TM	
TM_DNP2OFFP2:					;MIN=0
	MOV		A,#59
	MOV		TM_MIN2OFF,A
	DECMS	TM_HOUR2OFF
	NOP
	RET
TM_DNP2ONP:
	BTS1	TM2ONE0_F			;/=0
	RET
	MOV		A,TM_MIN2ON
	BTS0	FZ
	JMP		TM_DNP2ONP2
	DECMS	TM_MIN2ON
	RET
	MOV		A,TM_HOUR2ON
	BTS1	FZ
	RET
	JMP		KEYP_TOON_YY
TM_DNP2ONP2:					;MIN=0
	MOV		A,#59
	MOV		TM_MIN2ON,A
	DECMS	TM_HOUR2ON
	NOP
	RET
;**************************	
	
;**************************	
IR_PROCESS:
/*	BTS0	IRK_B		;RELAX.
	JMP		IRP_PRESS		;RET
       BTS1		FINISH_F		;CHECKING FINISH
        RET
        BCLR     FINISH_F
	CLR	ADP_CNT
	MOV	A,DATAH2
	CMPRS	A,DATAH3
	JMP	IRPE		;/= ,ERROR
	MOV	A,DATAL2
	CMPRS	A,DATAL3
	JMP	IRPE		;/= ,ERROR	
IR_PROCESS0:
	MOV	A,DATAH2
	XOR	A,#0X01
	BTS1	FZ		;
	JMP	IRPE		;/= ,ERROR	
	CLR		IRPRESS_TM
	MOV		A,DATAL2
	MOV		IR_DATAL_BUF,A
	MOV	A,DATAL2
	XOR	A,#0X3F
	BTS1	FZ		;
	JMP	IR_P1
	BSET	IRK_B
	JMP	KEYP_ONFK0
IR_P1:	
	MOV	A,DATAL2
	XOR	A,#0X3D
	BTS1	FZ		;
	JMP	IR_P11
	BSET	IRK_B
	JMP		KEYP_MODEK
IR_P11:		
	MOV	A,DATAL2
	XOR	A,#0X3B
	BTS1	FZ		
	JMP	IR_P12
	BSET	IRK_B
;	BTS0	ONF_F	
	JMP		KEYP_TMK
;	JMP		KEYP_YYK
IR_P12:	
	MOV	A,DATAL2
	XOR	A,#0X1E
	BTS1	FZ		
	JMP	IR_P13
	BSET	IRK_B
	JMP	KEYP_UPK	
IR_P13:	
	MOV	A,DATAL2
	XOR	A,#0X1C
	BTS1	FZ		
	JMP	IR_P14
	BSET	IRK_B
	JMP	KEYP_DNK
IR_P14:	
	MOV	A,DATAL2
	XOR	A,#0X37
	BTS1	FZ			
	JMP	IR_P15
	BSET	IRK_B
	JMP	KEYP_SWK
IR_P15:	
	MOV	A,DATAL2
	XOR	A,#0X3E
	BTS1	FZ			
	JMP	IR_P16
	BSET	IRK_B
	JMP	KEYP_SPK
IR_P16:	
IR_P17:	
	MOV	A,DATAL2
	XOR	A,#0X19
	BTS1	FZ			
	JMP	IR_P18
	BSET	IRK_B
	JMP	KEYP_2DPOFF
IR_P18:


IRPE:
	RET	  
IRP_PRESS:
	INCMS	IRPRESS_TM
	NOP
	MOV		A,IRPRESS_TM
	SUB		A,#120
	BTS1	FC
	JMP		IRPE
	MOV		A,#100
	MOV		IRPRESS_TM,A
	BSET	NOBZ_F
	MOV		A,IR_DATAL_BUF
	XOR		A,#0X1E
	BTS0	FZ		
	JMP		KEYP_UPK
	MOV		A,IR_DATAL_BUF
	XOR		A,#0X3E
	BTS0	FZ			
	JMP		KEYP_SPK
	MOV		A,IR_DATAL_BUF
	XOR		A,#0X1C
	BTS0	FZ		
	JMP		KEYP_DNK
	JMP		IRPE
*/
	RET		
;*******************************************	
ADP:	
	BTS0	ADFINISH_B
	JMP		ADP0		;RET	
	MOV		A,ADP_STEP
	XOR		A,#0
	BTS1	FZ
	JMP		ADP00
	BTS0	DIVFINISH_F
	JMP		ADP121
	RET
ADP00:	
	BTS0	DIVFINISH_F
	JMP		ADP311
	JMP		ADP3
	
ADP0:		
	INCMS	ADP_CNT
	NOP
	MOV		A,ADP_CNT
	XOR		A,#1
	BTS1	FZ
	JMP		ADP1
	MOV		A,DISC2RT_CNT1
	MOV		DISC2RT_CNT1_BUF,A
	MOV		A,DISC2RT_CNT2
	MOV		DISC2RT_CNT2_BUF,A
	MOV		A,DISC2RS_CNT
	MOV		DISC2RS_CNT_BUF,A	
	JMP		ADPE1
ADP1:
	MOV		A,DISC2RS_CNT
	ADD		DISC2RS_CNT_BUF,A
	RRCM	DISC2RS_CNT_BUF
	MOV		A,DISC2RT_CNT1
	ADD		DISC2RT_CNT1_BUF,A
	RRCM	DISC2RT_CNT1_BUF
	MOV		A,DISC2RT_CNT2
	ADD		DISC2RT_CNT2_BUF,A
	RRCM	DISC2RT_CNT2_BUF
	BTS1	FC
	JMP		ADP11
	MOV		A,#128
	ADD		DISC2RT_CNT1_BUF,A
	BTS1	FC
	JMP		ADP11
	INCMS	DISC2RT_CNT2_BUF
	NOP
ADP11:
	MOV		A,ADP_CNT
	SUB		A,#8
	BTS1	FC
	JMP		ADPE1			
	BCLR	FC
	RLCM	DISC2RT_CNT1_BUF
	RLCM	DISC2RT_CNT2_BUF
	BCLR	FC
	RLCM	DISC2RT_CNT1_BUF
	RLCM	DISC2RT_CNT2_BUF
	BCLR	FC
	RLCM	DISC2RT_CNT1_BUF
	RLCM	DISC2RT_CNT2_BUF
;	BCLR	FC
;	RLCM	DISC2RT_CNT1_BUF
;	RLCM	DISC2RT_CNT2_BUF

	MOV		A,DISC2RT_CNT2_BUF
	MOV		VAL00,A
	MOV		A,VAL00
	SUB		A,#10H	;02H
	BTS1	FC
	JMP		ADP12
	MOV		A,#10H	;02H
	MOV		VAL00,A
ADP12:	
	MOV		A,DISC2RT_CNT1_BUF
	MOV		VAL01,A

	MOV		A,DISC2RS_CNT_BUF
	MOV		VAL02,A
	MOV		A,VAL02
	XOR		A,#0
	BTS0		FZ
	JMP		ADPE			;=0,ERROR
	CLR		VAL03_BUF
ADP121:	
	CALL	DIV
	MOV		A,VAL03
	ADD		VAL03_BUF,A
	BTS0	FC
	JMP		ADP122
	BTS0	DIVFINISH_F
	RET						;NO FINISH
	JMP		ADP123	
ADP122:	
	MOV		A,#0FFH
	MOV		VAL03_BUF,A
ADP123:
	BCLR	DIVFINISH_F

	MOV		A,VAL03_BUF
	BTS1	FZ
	JMP		ADP123_2
ADP_DE0:
	MOV		A,DISC2RT_CNT2_BUF
	MOV		VAL00,A
	MOV		A,VAL00
	SUB		A,#10H	;02H
	BTS1	FC
	JMP		ADP_DE01
	MOV		A,#10H	;02H
	MOV		VAL00,A
ADP_DE01:	
	MOV		A,DISC2RT_CNT1_BUF
	MOV		VAL01,A
	MOV		A,DISC2RS_CNT_BUF
	MOV		VAL02,A
	BCLR	FC
	RLCM	VAL01
	RLCM	VAL00
	BCLR	FC
	RLCM	VAL01
	RLCM	VAL00
	BCLR	FC
	RLCM	VAL01
	RLCM	VAL00				;X8
	CALL	DIV
	MOV		A,VAL03
	MOV		VAL03_BUF,A
	MOV		A,VAL03_BUF
	MOV		NTDATA_BUF,A
	MOV		A,NTDATA_BUF
	SUB		A,#5
	BTS0	FC
	JMP		ADP_DE02
	MOV		A,#4EH
	MOV		NTC_ERR,A			;NTC SHORT 
	JMP		ADPE
ADP_DE02:
	MOV		A,#40
	MOV		ADP_PC,A
	BCLR	POWERON_F
	JMP		ADP22
		
ADP123_2:
	MOV		A,VAL03_BUF
	MOV		NTDATA_BUF,A
	MOV		A,NTDATA_BUF
	SUB		A,#29H		;20
	BTS1	FC
	JMP		ADP123_3		;>=
	MOV		A,#0E4H
	MOV		NTC_ERR,A		;NTC OPEN
	JMP		ADPE
ADP123_3:
	MOV		A,NTDATA_BUF
	SUB		A,#1AH		;20
	BTS1	FC
	JMP		ADP13
ADP2:
	CLR		ADP_PC
	BCLR	POWERON_F
	JMP		ADP22
ADP22:
	CLR		NTC_ERR
	MOV		A,CHK_TEMP_BUF1
	MOV		CHK_TEMP_BUF2,A
	MOV		A,ADP_PC
	MOV		CHK_TEMP_BUF1,A	
	BTS0	POWERON_F
	JMP		ADPGETTEMP0
	BSET	POWERON_F
	MOV		A,CHK_TEMP_BUF1
	MOV		TEMP_CHK,A
	JMP	ADPGETTEMPE
ADPGETTEMP0:	
	MOV		A,CHK_TEMP_BUF1
	XOR		A,TEMP_CHK
	BTS0	FZ
	JMP		ADPEQUTEMP					;=	
	CLR		TEMPEQU_CNT
ADPGETTEMP01:		
	MOV		A,CHK_TEMP_BUF1		;TEMP_CHK UP
	SUB		A,TEMP_CHK
	BTS1	FC
	JMP		ADPGETTEMPB
	CLR		TEMPLT_CNT
	INCMS	TEMPGT_CNT
	NOP	
	MOV		A,TEMPCHANGE_STEP
	XOR		A,#0
	BTS1	FZ
	JMP		ADPGETTEMPA
	MOV		A,CHK_TEMP_BUF1			;TEMP_CHK UP
	SUB		A,TEMP_CHK
	SUB		A,#4
	BTS0	FC
	JMP		ADPGETTEMPA01
	MOV		A,CHK_TEMP_BUF1			;TEMP_CHK UP
	SUB		A,TEMP_CHK
	SUB		A,#2
	BTS0	FC
	JMP		ADPGETTEMPA0	
	MOV		A,TEMPGT_CNT
	SUB		A,#5
	BTS1	FC		
	JMP		ADPGETTEMPE
ADPGETTEMPA0:	
	CLR		TEMPGT_CNT
	CLR		TEMPCHANGE_STEP
	INCMS	TEMP_CHK
	NOP	
	JMP		ADPGETTEMP2
ADPGETTEMPA01:
	MOV		A,CHK_TEMP_BUF1			;>=3
	SUB		A,#3
	MOV		TEMP_CHK,A
	JMP		ADPGETTEMP2
	
ADPGETTEMPA:
	MOV		A,TEMPGT_CNT
	SUB		A,#2
	BTS1	FC
	JMP		ADPGETTEMPE
	JMP		ADPGETTEMPA0
ADPGETTEMPB:						;<
	CLR		TEMPGT_CNT
	INCMS	TEMPLT_CNT
	NOP	
	MOV		A,TEMPCHANGE_STEP
	XOR		A,#2
	BTS1	FZ
	JMP		ADPGETTEMPB1
	MOV		A,TEMP_CHK			;TEMP_CHK DN
	SUB		A,CHK_TEMP_BUF1
	SUB		A,#4
	BTS0	FC
	JMP		ADPGETTEMPB01		
	MOV		A,TEMP_CHK			;TEMP_CHK DN
	SUB		A,CHK_TEMP_BUF1
	SUB		A,#2
	BTS0	FC
	JMP		ADPGETTEMPB0	
	MOV		A,TEMPLT_CNT
	SUB		A,#5
	BTS1	FC
	JMP		ADPGETTEMPE	
ADPGETTEMPB0:	
	CLR		TEMPLT_CNT
	MOV		A,#2
	MOV		TEMPCHANGE_STEP,A
	DECMS	TEMP_CHK
	NOP	
	JMP		ADPGETTEMP2
ADPGETTEMPB01:
	MOV		A,CHK_TEMP_BUF1
	ADD		A,#3
	MOV		TEMP_CHK,A
	JMP		ADPGETTEMP2	
ADPGETTEMPB1:
	MOV		A,TEMPLT_CNT
	SUB		A,#2
	BTS1	FC
	JMP		ADPGETTEMPE
	JMP		ADPGETTEMPB0
		
ADPEQUTEMP:
	CLR		TEMPLT_CNT
	CLR		TEMPGT_CNT
	MOV		A,TEMPCHANGE_STEP
	XOR		A,#1
	BTS1	FZ
	JMP		ADPEQUTEMP1
ADPEQUTEMP0:
	MOV		A,#1
	MOV		TEMPCHANGE_STEP,A	
	JMP		ADPGETTEMP2
ADPEQUTEMP1:	
	INCMS	TEMPEQU_CNT
	NOP
	MOV		A,TEMPEQU_CNT
	SUB		A,#2
	BTS1	FC
	JMP		ADPGETTEMPE
	JMP		ADPEQUTEMP0	

ADPGETTEMP2:
	NOP
ADPGETTEMPE:
	JMP		ADPE	
ADP13:
	INCMS	ADP_STEP
	NOP
	JMP		ADPE1		;RET			
ADP3:							;>10C
	MOV		A,DISC2RT_CNT2_BUF
	MOV		VAL00,A
/*	MOV		A,VAL00
	SUB		A,#02H
	BTS1	FC
	JMP		ADP31
	MOV		A,#02H
	MOV		VAL00,A	
*/	
ADP31:	
	MOV		A,DISC2RT_CNT1_BUF
	MOV		VAL01,A
	MOV		A,DISC2RS_CNT_BUF
	MOV		VAL02,A
	MOV		A,VAL02
	XOR		A,#0
	BTS0		FZ
	JMP		ADPE			;=0,ERROR
	BCLR	FC
	RLCM	VAL01
	RLCM	VAL00
	BCLR	FC
	RLCM	VAL01
	RLCM	VAL00
	BCLR	FC
	RLCM	VAL01
	RLCM	VAL00
	CLR		VAL03_BUF
ADP311:
	CALL	DIV
	MOV		A,VAL03
	ADD		VAL03_BUF,A
	BTS0	FC
	JMP		ADP312
	BTS0	DIVFINISH_F
	RET						;NO FINISH
	JMP		ADP313	
ADP312:	
	MOV		A,#0FFH
	MOV		VAL03_BUF,A
ADP313:
	CLR		ADP_STEP
	BCLR	DIVFINISH_F
	NOP
	MOV		A,VAL03_BUF
	MOV		NTDATA_BUF,A
	MOV	A,NTDATA_BUF
	SUB	A,#5
	BTS0	FC
	JMP	ADP3131
	MOV	A,#40
	MOV	ADP_PC,A
	BCLR	POWERON_F
	JMP		ADP22		
ADP3131:
	CLR		ADP_PC
ADP32:	
	B0MOV	Y,#ADGT10C_TABLE1$M
	B0MOV	Z,#ADGT10C_TABLE1$L
	MOV		A,ADP_PC			;
;	B0ADD	Z,A
	MOVCMP	
	MOV		DATA_BUF,A	
	MOV		A,NTDATA_BUF
	SUB		A,DATA_BUF
	BTS0	FC
	JMP		ADP33
	INCMS	ADP_PC
	NOP
	MOV		A,ADP_PC
	SUB		A,#40
	BTS1	FC	
	JMP		ADP32	
ADP33:
;	MOV		A,#5
;	ADD		ADP_PC,A
	JMP		ADP22	
ADPE:
;	CLR		CHKSPACE_TM1S
	CLR		CHKSPACE_TMNS
	CLR		ADP_CNT
	BCLR	DIVFINISH_F
ADPE1:
	BCLR	ADFINISH_B
	RET	
;==============  division ========= 
;input  val00,val01/val02= 
;output    ÉÌval03   ÓàÊýval04         
;**************************	
DIV: 
	   CLR    val03                    
	BCLR	DIVFINISH_F
DIV_0:
;	    MOV    a,val01                
 ;   	    MOV    val04,a                      
           MOV		A,VAL01
 	   SUB		A,VAL02
    	   BTS0    FC                    ;     
   	 JMP    div_1                        ;>=
   	 MOV    a,val00                      
  	  BTS0    FZ                    ;     
   	 JMP    div_end                      ;          
    	DECMS    val00
  	   NOP             ;                    
   	  MOV	A,#0			;0FFH
    	 SUB	A,VAL02
    	 ADD	VAL01,A
    	 JMP	DIV_11
div_1:                                    
	MOV		VAL01,A
DIV_11:	
    	INCMS    val03
    	NOP
    	MOV		A,VAL03
    	SUB		A,#0F0H
    	BTS1	FC    	
 ;	BTS1	PRO_F
    	 JMP    div_0 			
 ; 	BSET	DIVFINISH_F  	 
    	 MOV	A,#0FFH
;   	 MOV	VAL03,A        
   	 JMP    div_end		;div_0                        
div_end:    
	RET                         
;*******************************
HEX2DECP:
	MOV		A,HEXD
	MOV		DECD,A
	BTS0	HEXGT100_F
	JMP		HEX2DECP1
	MOV		A,HEXD
	SUB		A,#100		;50
	BTS0	FC
	RET
HEX2DECP1:	
	CLR		DECD
	CLR		DATA_BUF
HEX2DECP2:		
	MOV		A,HEXD
	SUB		A,#0AH
	BTS1	FC
	JMP		HEX2DECP3
	MOV		HEXD,A	
	MOV		A,#10H
	ADD		DECD,A
	MOV		A,DECD
	AND		A,#0F0H
	SUB		A,#0A0H
	BTS1	FC
	JMP		HEX2DECP2
	CLR		DECD	
	MOV		A,#1
	ADD		DATA_BUF,A
	JMP		HEX2DECP2
HEX2DECP3:	
	MOV		A,HEXD
	ADD		DECD,A
	MOV		A,DP_MODE
	XOR		A,#0
	BTS0	FZ
	RET
	MOV		A,DATA_BUF
	BTS0	FZ
	RET
	SWAPM	DECD
	MOV		A,#0FH
	AND		DECD,A
	SWAP	DATA_BUF
	AND		A,#0F0H
	OR		DECD,A
	RET
;***********************************	
KEYP:
	MOV		A,KEYV_NEW
	MOV		KEYV_OLD,A
	MOV		A,#0FFH
	MOV		KEYV_NEW,A
	MOV		A,P2
	MOV		KEYV_NEW,A
		
	MOV		A,KEYV_OLD
	XOR		A,KEYV_NEW	
	BTS1	FZ
	CLR		KEY_CNT
	INCMS		KEY_CNT
	NOP
	MOV		A,KEY_CNT
	SUB		A,#5
	BTS1	FC
	RET
	MOV		A,#252
	MOV		KEY_CNT,A
	MOV		A,KEYV_NEW
	XOR		A,#0FFH
	BTS1	FZ
	JMP		KEYP0
	BCLR	KRELAX_F
;	BCLR	OFFKRELAX_F
;	BCLR	ONSPKRELAX_F
;	CLR		KP_TM
;	BCLR	KP3S_F					
	BTS1	ONFKRELAX_F
	JMP	KEYPA1
	BTS1	ONF_F
	JMP		KEYPA1
	BTS0	KEYHAVE_F
	JMP		KEYPA1
	BCLR	ONFKRELAX_F	
	JMP		KEYP_ONFK0
KEYPA1:
	BCLR	KEYHAVE_F
	BCLR	ONFKRELAX_F
	CLR	KP_TM
	BCLR	KP3S_F					
	RET
		
KEYP0:						;HAVE KEY IN
	BTS1	KRELAX_F
	JMP		KEYP001	
	BTS0	KEYV_NEW.ONFK_B
	RET		
	BTS1	ONF_F
	RET
	BTS0	ONFKRELAX_F
	JMP		KEYP_ONFKPRESS
	BSET	ONFKRELAX_F
	JMP		KEYP_TOOFF	

KEYP_ONFKPRESS:
	BTS0	KP3S_F
	RET
	INCMS	KP_TM
	NOP
	MOV		A,KP_TM
	SUB		A,#200
	BTS1	FC
	RET
	MOV		A,#200
	MOV		KP_TM,A
	BSET	KP3S_F
	BSET	KEYHAVE_F
KEYP_2DPOFF:
	BSET	DPOFF_F
	JMP		KEYP_BZPM1
	
KEYP001:
	BSET	KRELAX_F	
	BTS1	DPOFF_F
	JMP		KEYP_ONFK
KEYP_DPONP:	
	BCLR	DPOFF_F
	BSET	KEYHAVE_F
	BTS1	KEYV_NEW.ONFK_B
	BSET	ONFKRELAX_F	
	JMP		KEYP_BZPM1	
KEYP_ONFK:
	BTS0	KEYV_NEW.ONFK_B
	JMP		KEYP2
	BSET	ONFKRELAX_F
	BTS0	ONF_F
	RET					
KEYP_ONFK0:		
	BSET	KEYHAVE_F
	CLR		DP_MODE
	CLR		LEDFLASH_TM
	CLR		LEDFLASH_STEP
	BTS0	ONF_F
	JMP		KEYP_TOOFF
KEYP_TOON:	
;	BTS0	TEMPSSERR_F
;	JMP	KEYP_TOOFF
	TMCLRP
KEYP_TOON_YY:	
	BSET	ONF_F			;TO ON
;	mov	a,#01h
;	mov	testd,a
	B0MOV	Y,#SP_TABLE1$M
	B0MOV	Z,#SP_TABLE1$L
	MOV	A,#0		;31
	MOVCMP	
	MOV	PWMC,A
	CALL	NATURE_INIT1
	JMP		KEYP_ONBZP
KEYP_TOOFF:	
	TMCLRP
KEYP_TOOFF_TM:	
	BCLR	ONF_F		;TO OFF
	BCLR	DPOFF_F
	CALL	NATURE_INIT1
	CLR		TM_STEP
	TMCLRP
	MOV		A,MODE
	XOR		A,#2
	BTS0	FZ
	CLR		MODE			;SLP MODE
	JMP		KEYP_OFFBZP
KEYP2:
	BTS0	KEYV_NEW.MODEK_B
	JMP		KEYP3
KEYP_MODEK:	
	MOV	A,DP_MODE
	BTS1	FZ
	CALL	KEYP_BZPM1
	CLR	DP_TM
	CLR	DP_MODE
	BTS0	DPOFF_F
	JMP	KEYP_DPONP
	BTS0	TM2ONE0_F
	JMP		KEYP_MODEK1
	BTS1	ONF_F
	RET
KEYP_MODEK1:	
	INCMS	MODE
	NOP
;	BCLR	AIMODEOFF_F
	MOV	A,MODE
	SUB	A,#4
	BTS1	FC
	JMP	KEYP_MODEK11
	CLR	MODE
	MOV	A,#11
	MOV	SPEED,A
	JMP	KEYP_BZPM1
KEYP_MODEK11:	
	CALL	NATURE_INIT1
	MOV		A,MODE
	XOR		A,#1
	BTS0	FZ
	CALL	NATURE_INIT	
KEYP_MODEK2:
	MOV		A,MODE
	XOR		A,#3
	BTS1	FZ
	JMP		KEYP_BZPM1
;	CALL	AIMODE_INITP
	JMP		KEYP_BZPM1		;KEYP_MODEK11		
KEYP3:
	BTS0	KEYV_NEW.SWK_B
	JMP		KEYP4
KEYP_SWK:	
	MOV	A,DP_MODE
	BTS1	FZ
	CALL	KEYP_BZPM1
	CLR	DP_MODE
	CLR	DP_TM
	BTS0	DPOFF_F
	JMP		KEYP_DPONP
	BTS0	TM2ONE0_F
	JMP		KEYP_SWK1
	BTS1	ONF_F
	RET
KEYP_SWK1:	
	INCMS	SW
	NOP
	JMP	KEYP_BZPM1
KEYP4:
	BTS0	KEYV_NEW.TMK_B
	JMP		KEYP5
KEYP_TMK:	
;	bclr	fc
;	rlcm	testd
	BTS0	DPOFF_F
	JMP		KEYP_DPONP
KEYP_TMUPK:
	CLR	DP_TM	
	BTS1	ONF_F
	JMP	KEYP_TMUPK_02
	MOV	A,DP_MODE
	XOR	A,#1
	BTS0	FZ
	JMP	KEYP_TMUPK03
	BTS0	TM2OFFE0_F			;=0
	JMP	KEYP_TMUPKE1
	MOV	A,#1
	MOV	DP_MODE,A	
	JMP	KEYP_TMUPK03
KEYP_TMUPK_02:
	MOV	A,DP_MODE
	XOR	A,#2
	BTS0	FZ
	JMP	KEYP_TMUPK03
	BTS0	TM2ONE0_F			;=0
	JMP	KEYP_TMUPKE1
	MOV	A,#2
	MOV	DP_MODE,A	
	JMP	KEYP_TMUPK03	
KEYP_TMUPK03:	
	CALL	TM2BUFP		
KEYP_TMUPK1:
	CLR		TM_1MIN
	MOV		A,TM_HOUR_BUF
	SUB		A,#15
	BTS1	FC
	JMP		KEYP_TMUPK10
	CLR	TM_HOUR_BUF	
	CLR	TM_MIN_BUF
	JMP	KEYP_TMUPKE
KEYP_TMUPK10:	
	MOV		A,TM_HOUR_BUF
	SUB		A,#3
	BTS1	FC
	JMP		KEYP_TMUPK2
KEYP_TMUPK11:
	INCMS	TM_HOUR_BUF
	NOP
	CLR		TM_MIN_BUF
	JMP		KEYP_TMUPKE
KEYP_TMUPK2:					;<3 HOUR
	MOV		A,TM_MIN_BUF
	SUB		A,#30
	BTS0	FC
	JMP		KEYP_TMUPK11
	MOV		A,#30
	MOV		TM_MIN_BUF,A
	JMP		KEYP_TMUPKE			
KEYP_TMUPKE:
	CALL	BUF2TMP
	CALL	TME0_CHKP
KEYP_TMUPKE1:
	BTS1	ONF_F
	JMP		KEYP_TMK11
	BTS1	TM2OFFE0_F			;/=0
	JMP	KEYP_TMKRST	
	MOV		A,#1
	MOV		DP_MODE,A
	JMP		KEYP_TMK0	
KEYP_TMK11:
	BTS1	TM2ONE0_F			;/=0
	JMP	KEYP_TMKRST	
	MOV		A,#2
	MOV		DP_MODE,A
	JMP		KEYP_TMK0
KEYP_TMK0:		
	CLR		DP_TM
	JMP		KEYP_BZPM1
KEYP_TMKRST:
	CLR	DP_MODE
	JMP	KEYP_TMK0	
KEYP5:
KEYP8:
	RET
KEYP_SPK:
	BTS0	DPOFF_F
	JMP	KEYP_DPONP
	BTS0	ONF_F
	JMP	KEYP_SPK1
	BTS0	TM2ONE0_F
	JMP	KEYP_SPK1
	MOV	A,DP_MODE
	XOR	A,#2
	BTS1	FZ
	RET
KEYP_SPK1:	
	MOV		A,MODE
	SUB		A,#3
	BTS0	FC
	RET						;ZN,ZDY	
	CLR		DP_MODE		;TO DP SP
	CLR		DP_TM			
	MOV		A,MODE
	BTS1	FZ
	JMP		KEYP_SPK_NATP
	MOV		A,SPEED
	SUB		A,#23
	BTS1	FC
	JMP	KEYP_SPK10		;RET
	CLR	SPEED
	JMP		KEYP_BZPM1	
KEYP_SPK10:	
	INCMS	SPEED
	NOP
	JMP		KEYP_BZPM1		
KEYP_SPK_NATP:
	MOV		A,NATURE_SPEED
	SUB		A,#4
	BTS0	FC
	JMP		KEYP_SPK_NATP1		;RET
	INCMS	NATURE_SPEED
	NOP
KEYP_SPK_NATP0:	
	CALL	NATURE_INIT1
	JMP		KEYP_BZPM1
KEYP_SPK_NATP1:
	CLR	NATURE_SPEED
	JMP	KEYP_SPUPK_NATP0	
	

KEYP_OFFBZP:
	MOV	A,#3
	MOV	BZ_MODE,A
	JMP	KEYP_BZP
KEYP_ONBZP:
	MOV		A,#2		;ON
	MOV		BZ_MODE,A
  	JMP		KEYP_BZP
KEYP_BZP:
	BTS0	NOBZ_F
	CLR		BZ_MODE	
	BCLR	NOBZ_F
	CLR	BZ_TM
;	CLR		KEYOFF_TMNS
	BSET	KEYIN_F
	RET
KEYP_BZPM1:
	MOV		A,#1
	MOV		BZ_MODE,A	
	JMP		KEYP_BZP		
;**************************	
;**************************	
TM2BUFP:					
	MOV		A,TM_MIN2OFF
	MOV		TM_MIN_BUF,A
	MOV		A,TM_HOUR2OFF
	MOV		TM_HOUR_BUF,A
	MOV		A,DP_MODE
	XOR		A,#1
	BTS0	FZ
	RET
	MOV		A,TM_MIN2ON
	MOV		TM_MIN_BUF,A
	MOV		A,TM_HOUR2ON
	MOV		TM_HOUR_BUF,A
	RET
;**************************	
BUF2TMP:	
	MOV		A,DP_MODE
	XOR		A,#1
	BTS1	FZ
	JMP		BUF2TMP2
	MOV		A,TM_HOUR_BUF
	MOV		TM_HOUR2OFF,A
	MOV		A,TM_MIN_BUF
	MOV		TM_MIN2OFF,A	
	RET
BUF2TMP2:
	MOV		A,TM_HOUR_BUF
	MOV		TM_HOUR2ON,A
	MOV		A,TM_MIN_BUF
	MOV		TM_MIN2ON,A	
	RET
;**************************	
NATURE_INIT:
	CLR		NATURE_SPEED
	MOV		A,SPEED
	SUB		A,#5
	BTS1	FC
	JMP		NATURE_INIT1
	INCMS	NATURE_SPEED
	NOP
	MOV		A,SPEED
	SUB		A,#10
	BTS1	FC
	JMP		NATURE_INIT1
	INCMS	NATURE_SPEED
	NOP
	MOV		A,SPEED
	SUB		A,#15
	BTS1	FC
	JMP		NATURE_INIT1
	INCMS	NATURE_SPEED
	NOP
	MOV		A,SPEED
	SUB		A,#20
	BTS1	FC
	JMP		NATURE_INIT1
	INCMS	NATURE_SPEED
	NOP
NATURE_INIT1:
;	CLR		SLP_TM1S
	CLR		SLP_TM1MIN
	CLR		SLP_TMNMIN
NATURE_INIT2:
	MOV	A,MODE
	SUB	A,#1
	BTS1	FC
	RET
	MOV	A,MODE
	SUB	A,#3
	BTS0	FC
	RET	
	CLR		NATURE_STEP
	CLR		NATURE_TM1S
	CLR		NATURE_TMNS
	B0MOV	Y,#NATS0_TABLE$M
	B0MOV	Z,#NATS0_TABLE$L
	MOV		A,NATURE_SPEED
;	AND		A,#0FH
;	B0ADD	Z,A
;	MOVC	
	MOVCMP
	MOV		SPEED_AUTO,A	
	BCLR	NATUPDN_F
	RET
;**************************************	
LEDP:							;10MS
	BSET	LEDSTB_B
	BSET	LEDCLK_B
	BSET	LEDDATA_B
	INCMS	LEDP_CNT
	NOP
	MOV		A,LEDP_CNT
	SUB		A,#10
	BTS1	FC
	JMP		LEDP_RET
	CLR		LEDP_CNT			;100MS
	INCMS	DP_TM
	NOP
	MOV		A,DP_TM
	SUB		A,#30
	BTS1	FC
	JMP		LEDP003
	CLR		DP_TM			;5S
	BCLR	TMSET_F
	BTS0	TM2ONE0_F	
	JMP		LEDP001
	BTS0	TM2OFFE0_F	
	JMP		LEDP001
	CLR		DP_MODE
	JMP		LEDP003
LEDP001:	
	MOV		A,DP_MODE
	BTS1	FZ
	JMP		LEDP001_2
	BTS1	ONF_F
	JMP		LEDP001_1	
	BTS1	TM2OFFE0_F	
	JMP		LEDP001_2	
	MOV		A,#1
	MOV		DP_MODE,A
	JMP		LEDP003	
LEDP001_1:	
	BTS1	TM2ONE0_F	
	JMP		LEDP001_2	
	MOV		A,#2
	MOV		DP_MODE,A
	JMP		LEDP003	
	
LEDP001_2:
	CLR		DP_MODE
	JMP		LEDP003	
LEDP003:		
	INCMS	LEDFLASH_TM
	NOP
	MOV		A,LEDFLASH_TM
	SUB		A,#5
	BTS1	FC
	JMP		LEDP01
	CLR		LEDFLASH_TM			;0.5S
	INCMS	LEDFLASH_STEP
	NOP
LEDP01:	
	MOV		A,#02H		;00H(4DIG);03H(7GR);02H(6GR)
	MOV		COMMAND_MODE,A		;
	MOV		A,#40H
	MOV		COMMAND_DATA,A
	MOV		A,#0C0H
	MOV		COMMAND_ADDRESS,A		;FROM 00H,DIG1
LEDP1:	
	MOV		A,COMMAND_MODE
	MOV		COMMAND_BUF,A
	CALL	LEDP_TXP
LEDP2:	
	BSET	LEDSTB_B
	BSET	LEDCLK_B
	CALL	LEDP_DELAYP
	CALL	LEDP_DELAYP
	MOV	A,COMMAND_DATA
	MOV	COMMAND_BUF,A
	CALL	LEDP_TXP
LEDP3:	
	BSET	LEDSTB_B
	BSET	LEDCLK_B
	CALL	LEDP_DELAYP
	CALL	LEDP_DELAYP
	MOV	A,COMMAND_ADDRESS
	MOV	COMMAND_BUF,A
	CALL	LEDP_TXP
LEDP4:
	BSET	LEDCLK_B
	CALL	LEDP_DELAYP
	CALL	LEDP_DELAYP
LEDP_S00H:						
	CLR		COMMAND_BUF	
	CLR		DATA_BUF
	MOV		A,DP_MODE
	XOR		A,#0
	BTS0	FZ
	JMP		LEDP_S00H2		;DP SPEED
	CALL	GET_TMDIG
	BTS0	DPTMDOT_F
	JMP		LEDP_S00H10			;HAVE DOT ,
	MOV		A,TM_DIG
	MOV		HEXD,A
LEDP_S00H1:			
	BCLR	HEXGT100_F
	MOV		A,DP_MODE
	XOR		A,#0
	BTS1	FZ
	BSET	HEXGT100_F		
	CALL	HEX2DECP
	MOV		A,DECD
	MOV		TM_DIG,A
LEDP_S00H10:					
	B0MOV	Y,#LCD_TABLE1$M
	B0MOV	Z,#LCD_TABLE1$L
	MOV	A,TM_DIG
	AND		A,#0FH
;	B0ADD	Z,A
	MOVCMP	
	MOV		DATA_BUF,A	
	CALL	GET_DP_DATA	
	MOV		A,DP_MODE
	XOR		A,#0
	BTS0	FZ
	JMP		LEDP_S00HE	
;	BTS0	DPTMDOT_F
;	BSET	COMMAND_BUF.6			;DOT		
	JMP		LEDP_S00HE
LEDP_S00H2:						;DP SPEED  
	BTS0	ONF_F
	JMP		LEDP_S00H200
	BTS1	TM2ONE0_F
	JMP		LEDP_S00HE
LEDP_S00H200:	
	MOV		A,MODE
	BTS1	FZ
	JMP		LEDP_S00H21
	INCS	SPEED			;NORMAL FAN
	NOP
LEDP_S00H20:
	MOV	SPEED_DP,A
	MOV		HEXD,A
	DECMS	SPEED_DP
	NOP
	JMP		LEDP_S00H1
LEDP_S00H21:
	MOV		A,MODE
	XOR		A,#3
	BTS1	FZ
	JMP		LEDP_S00H22
;	INCS	SPEED_AUTO
;	NOP
LEDP_S00H21_1:
	MOV		A,#0E1H
	JMP		LEDP_S00H20
;	MOV		TM_DIG,A			;DP AI
;	JMP		LEDP_S00H10			;LEDP_S08H20	
LEDP_S00H22:
	INCS	NATURE_SPEED
	NOP
;	MOV		A,SPEED_AUTO
	JMP		LEDP_S00H20	
						
LEDP_S00HE:
;	mov	a,testd
;	mov	COMMAND_BUF,a	
	CALL	LEDP_TXP

LEDP_S01H:				;			
	CLR		COMMAND_BUF	
LEDP_S01HE:
	CALL	LEDP_TXP
LEDP_S02H:				
	CLR		COMMAND_BUF
	CLR		DATA_BUF
	MOV		A,DP_MODE
	XOR		A,#0
	BTS0	FZ
	JMP		LEDP_S02H2
LEDP_S02H0:				
	B0MOV	Y,#LCD_TABLE1$M
	B0MOV	Z,#LCD_TABLE1$L
	SWAP	TM_DIG
	AND		A,#0FH
;	B0ADD	Z,A
;	MOVC	
	MOVCMP
	MOV		DATA_BUF,A	
	CALL	GET_DP_DATA	
	BTS0	DPTMDOT_F
	BSET	COMMAND_BUF.2			;DOT		
/*	MOV		A,DP_MODE
	XOR		A,#0
	BTS1	FZ
	BSET	COMMAND_BUF.6			;DP TM "H"	
*/		
	JMP		LEDP_S02HE
LEDP_S02H2:						;DP SPEED
	BCLR	DPTMDOT_F
	BTS0	ONF_F
	JMP		LEDP_S02H0
;	MOV		A,TM_STEP
;	BTS1	FZ
	BTS0	TM2ONE0_F
	JMP		LEDP_S02H0
LEDP_S02HE:
	CALL	LEDP_TXP
LEDP_S03H:						
	CLR		COMMAND_BUF	
LEDP_S03HE:
	CALL	LEDP_TXP
LEDP_S04H:						
	CLR	COMMAND_BUF	
LEDP_S04HE:
	CALL	LEDP_TXP
LEDP_S05H:						
	CLR	COMMAND_BUF	
LEDP_S05HE:
	CALL	LEDP_TXP
LEDP_S06H:						
	CLR	COMMAND_BUF	
LEDP_S06HE:
	CALL	LEDP_TXP
LEDP_S07H:						
	CLR	COMMAND_BUF	
LEDP_S07HE:
	CALL	LEDP_TXP
LEDP_S08H:						
	CLR	COMMAND_BUF	
	BTS1	DPON_F
	JMP	LEDP_S08HE
	BTS1	SW.0
	JMP	LEDP_S08H1
	BSET	COMMAND_BUF.3			;SW
LEDP_S08H1:	
	MOV		A,MODE
	XOR		A,#1
	BTS0	FZ
	BSET	COMMAND_BUF.4			;RHY
	MOV		A,MODE
	XOR		A,#2
	BTS0	FZ
	BSET	COMMAND_BUF.5			;SLP
LEDP_S08HE:
	CALL	LEDP_TXP
LEDP_S09H:						
	CLR		COMMAND_BUF	
LEDP_S09HE:
	CALL	LEDP_TXP
LEDP_S0AH:						
	CLR	COMMAND_BUF	
	BTS1	DPON_F
	JMP	LEDP_S0AHE
	MOV		A,MODE
	XOR		A,#3
	BTS0	FZ
	BSET	COMMAND_BUF.5			;AI-MODE
	BTS0	TM2ONE0_F
	BSET	COMMAND_BUF.4		;TM
	BTS0	TM2OFFE0_F
	BSET	COMMAND_BUF.4		;TM	
LEDP_S0AHE:
	CALL	LEDP_TXP
	
	
LEDP5:	
	BSET	LEDSTB_B
	BSET	LEDCLK_B
	CALL	LEDP_DELAYP
	CALL	LEDP_DELAYP
	MOV		A,#8FH		;8BH	;88H	;COMMAND_ADDRESS  ;8FH(ALL ON)
	MOV		COMMAND_BUF,A
	BTS1	DPOFF_F
	JMP		LEDP51
	MOV		A,#80H
	MOV		COMMAND_BUF,A		;OFF DP
/*	MOV		A,MODE
	XOR		A,#2
	BTS0	FZ
	JMP		LEDP52
	MOV		A,MODE
	XOR		A,#3
	BTS0	FZ
	JMP		LEDP52
*/	
LEDP51:	
	CALL	LEDP_TXP
	CALL	LEDP_DELAYP
	CALL	LEDP_DELAYP
	BSET	LEDSTB_B
	BSET	LEDCLK_B
	BSET	LEDDATA_B			
	JMP		LEDP_RET
LEDP52:						;
/*	MOV		A,KEYOFF_TMNS
	SUB		A,#5
	BTS1	FC
	JMP		LEDP51
	BCLR	COMMAND_BUF.3			;OFF LED
	JMP		LEDP51	
*/	
LEDP_RET:
	RET	
;**************************	
LEDP_TXP:
	BCLR	LEDSTB_B
	MOV		A,#8
	MOV		LEDTX_BIT,A
LEDP_TXP10:	
	BCLR	LEDCLK_B
	RRCM	COMMAND_BUF	
	BTS0	FC
	JMP		LEDP_TXP11
	BCLR	LEDDATA_B
	JMP		LEDP_TXP12
LEDP_TXP11:
	BSET	LEDDATA_B
LEDP_TXP12:
	CALL	LEDP_DELAYP
	BSET	LEDCLK_B
	CALL	LEDP_DELAYP
	DECMS	LEDTX_BIT			
	JMP		LEDP_TXP10	
	RET
;**************************	
LEDP_DELAYP:
	NOP
	NOP
	NOP
	NOP
	RET
;**************************
;**************************
GET_TMDIG:
	CLR		TM_DIG
	MOV		A,TM_MIN2OFF
	MOV		TM_MIN_BUF,A
	MOV		A,TM_HOUR2OFF
	MOV		TM_HOUR_BUF,A
	MOV		A,DP_MODE
	XOR		A,#1
	BTS0	FZ
	JMP		GET_TMDIG1
	MOV		A,TM_MIN2ON
	MOV		TM_MIN_BUF,A
	MOV		A,TM_HOUR2ON
	MOV		TM_HOUR_BUF,A
GET_TMDIG1:
	MOV		A,TM_HOUR_BUF
	SUB		A,#9
	BTS1	FC
	JMP		GET_TMDIG2
	BTS1	FZ
	JMP		GET_TMDIG11
	MOV		A,TM_MIN_BUF
	SUB		A,#31
	BTS1	FC
	JMP		GET_TMDIG2
GET_TMDIG11:	
	BCLR	DPTMDOT_F
	MOV		A,TM_HOUR_BUF
	MOV		TM_DIG,A
	MOV		A,TM_MIN_BUF
	BTS0	FZ
	RET
	INCMS	TM_DIG
	NOP
	RET
GET_TMDIG2:
	BSET	DPTMDOT_F
	SWAP	TM_HOUR_BUF
	AND		A,#0F0H
	MOV		TM_DIG,A
	
	MOV		A,TM_MIN_BUF
	SUB		A,#31
	BTS1	FC
	JMP		GET_TMDIG21
	MOV		A,#10H
	ADD		TM_DIG,A
	RET	
GET_TMDIG21:
	MOV		A,TM_MIN_BUF
	BTS0	FZ
	RET	
	MOV		A,#05H
	ADD		TM_DIG,A		
	RET
	RET
;**************************
GET_DP_DATA:
	BTS0	DATA_BUF.AA_B
	BSET	COMMAND_BUF.6
	BTS0	DATA_BUF.BB_B
	BSET	COMMAND_BUF.7
	BTS0	DATA_BUF.CC_B
	BSET	COMMAND_BUF.0
	BTS0	DATA_BUF.DD_B
	BSET	COMMAND_BUF.3
	BTS0	DATA_BUF.EE_B
	BSET	COMMAND_BUF.1	
	BTS0	DATA_BUF.FF_B
	BSET	COMMAND_BUF.5
	BTS0	DATA_BUF.GG_B
	BSET	COMMAND_BUF.4	
	RET	
;**************************	
NATUREP:					;20MS
	BTS1	ONF_F
	RET
/*	MOV		A,STR_TM
	SUB		A,#150
	BTS1	FC
	RET
*/	
	MOV		A,MODE
	SUB		A,#1
	BTS1	FC
	RET
	MOV		A,MODE
	SUB		A,#3
	BTS0	FC
	RET
/*	INCMS	NATURE_TM1S
	NOP
	MOV		A,NATURE_TM1S
	SUB		A,#100
	BTS1	FC
	JMP		NATUREP001
	CLR		NATURE_TM1S
*/
;	INCMS	NATURE_TMNS
;	NOP
;	INCMS	NATURE_STEP
;	NOP
NATUREP001:	
	MOV		A,MODE
	XOR		A,#1
	BTS0	FZ
	JMP		NATUREP_NATM
	MOV		A,MODE
	XOR		A,#2
	BTS1	FZ			;SLEEP FAN
	RET	
NATUREP_SLPM:	
	BTS1	SLP_TM1S_F
	JMP		NATUREP_NATM
	BCLR	SLP_TM1S_F		
	BTS0	TMTEST_F
	JMP		NATUREP_SLPM_T1	;TEST
	INCMS	SLP_TM1MIN
	NOP
	MOV		A,SLP_TM1MIN
	SUB		A,#60
	BTS1	FC					;>=
	JMP		NATUREP_NATM	
NATUREP_SLPM_T1:	
	CLR		SLP_TM1MIN		
	INCMS	SLP_TMNMIN
	NOP							;TEST
	MOV		A,SLP_TMNMIN
	SUB		A,#30
	BTS1	FC					;>=
	JMP		NATUREP_NATM	
	CLR		SLP_TMNMIN				
;	CLR		NATURE_TM1S
	CLR		NATURE_TMNS
	CLR		NATURE_STEP
	MOV		A,NATURE_SPEED
	BTS0	FZ
	JMP		NATUREP_NATM		
	DECMS	NATURE_SPEED
	NOP
	CALL	NATURE_INIT2
	JMP		NATUREP_NATM
NATUREP_NATM:
	INCMS	NATURE_TM1S
	NOP
	MOV		A,NATURE_TM1S
	SUB		A,#100
	BTS1	FC
	RET
	CLR		NATURE_TM1S
	BTS0	NATUPDN_F
	JMP	NATUREP_NAT_SPDN
NATUREP_NAT_SPUP:	
	B0MOV	Y,#NATUREP_NAT_SPUP_TABLE$M
	B0MOV	Z,#NATUREP_NAT_SPUP_TABLE$L
	MOV	A,NATURE_SPEED
	MOVCMP	
	MOV	DATA_BUF,A
	MOV	A,SPEED_AUTO
	SUB	A,DATA_BUF
	BTS0	FC
	JMP	NATUREP_NAT_SPUP1
	INCMS	SPEED_AUTO
	NOP
	RET	
NATUREP_NAT_SPUP1:	
	MOV	A,DATA_BUF
	MOV	SPEED_AUTO,A
	BSET	NATUPDN_F
	RET
NATUREP_NAT_SPDN:	
	B0MOV	Y,#NATUREP_NAT_SPDN_TABLE$M
	B0MOV	Z,#NATUREP_NAT_SPDN_TABLE$L
	MOV	A,NATURE_SPEED
	MOVCMP	
	MOV	DATA_BUF,A
	MOV	A,DATA_BUF
	SUB	A,SPEED_AUTO
	BTS0	FC
	JMP	NATUREP_NAT_SPDN1
	DECMS	SPEED_AUTO
	NOP
	RET	
NATUREP_NAT_SPDN1:	
	MOV	A,DATA_BUF
	MOV	SPEED_AUTO,A
	BCLR	NATUPDN_F
	RET
;**************************
;**************************
AI_MODEP:			
	BTS1	ONF_F
	RET
	MOV		A,MODE
	XOR		A,#3
	BTS1	FZ
	RET
	CLR		SPEED_AUTO
	MOV		A,TEMP_CHK
	AND		A,#7FH
	SUB		A,#16
	BTS0	FC
	JMP		AI_MODEP1
AI_MODEP0:	
	MOV		A,#24
	MOV		SPEED_AUTO,A		;OFF
	RET
AI_MODEP1:
	MOV	A,#2
	MOV	SPEED_AUTO,A
	MOV	A,TEMP_CHK
	AND	A,#7FH
	SUB	A,#21
	BTS1	FC
	RET	
	MOV	DATA_BUF,A
AI_MODEP11:	
	MOV	A,DATA_BUF
	BTS0	FZ
	RET
	MOV	A,#2
	ADD	SPEED_AUTO,A
	MOV	A,SPEED_AUTO
	SUB	A,#24
	BTS1	FC
	JMP	AI_MODEP12
	MOV	A,#24
	MOV	SPEED_AUTO,A
	RET	
AI_MODEP12:	
	DECMS	DATA_BUF
	NOP
	JMP	AI_MODEP11
;**************************		;125US ONE TIMES	
CHKP:
	BCLR	CHKINPM_B
     MOV	A,CHKSPACE_TMNS
     SUB	A,#30		;5
     BTS0	FC
     JMP	CHKP0	
     RET
CHKP01:						;NO TO SPACE TM
	CLR	CHK_STEP
	CLR	CHARGE_CNT1
	CLR	CHARGE_CNT2
	JMP	CHKP_CHARGE	
CHKP0:
	BTS0	DIVFINISH_F
	RET					;JMP		CHKP01
	BTS0	ADFINISH_B
	RET
        MOV		A,CHK_STEP
;   	B0ADD	PCL,A    
	@JMP_A	5
   	JMP		 CHKP_CHARGE
   	JMP		 CHKP_DIS2RS
   	JMP		 CHKP_CHARGE
   	JMP		 CHKP_DIS2RT
   	JMP		CHKP4
CHKP_CHARGE:
	BSET	RSM_B
	BSET	RTM_B
	BCLR	RS_B
	BCLR	RT_B
	INCMS	CHARGE_CNT1	
	JMP		CHKP_CHARGE1
	INCMS	CHARGE_CNT2	
	NOP
CHKP_CHARGE1:	
	MOV		A,CHARGE_CNT2
	SUB		A,#2
	BTS1	FC
	RET
	INCMS	CHK_STEP
	NOP
	JMP		CHKP60		;RET
/*CHKP1:
	MOV		A,CHK_STEP
	CMPRS	A,#1
	JMP		CHKP2
*/	
CHKP_DIS2RS:
	BCLR	RTM_B
	BSET	RSM_B
	BSET	RS_B
	INCMS	DISC2RS_CNT	
	JMP		CHKP_DIS2RS1
	MOV		A,#0FFH
	MOV		DISC2RS_CNT	,A
	JMP		CHKP_DIS2RS2
CHKP_DIS2RS1:	
	BTS1	CHKINP_B
	RET
CHKP_DIS2RS2:	
	INCMS	CHK_STEP
	NOP
;	MOV		A,DISC2RS_CNT
;	MOV		DISC2RS_CNT_BUF,A	
	JMP		CHKP61				;RET
/*CHKP2:
	MOV		A,CHK_STEP
	CMPRS	A,#2
	JMP		CHKP3
	JMP		CHKP_CHARGE
CHKP3:
	MOV		A,CHK_STEP
	CMPRS	A,#3
	JMP		CHKP4
*/	
CHKP_DIS2RT:
	BCLR	RSM_B
	BSET	RTM_B
	BSET	RT_B
	INCMS	DISC2RT_CNT1
	JMP		CHKP_DIS2RT1
	INCMS	DISC2RT_CNT2
	JMP		CHKP_DIS2RT1
CHKP_DIS2RT1:	
	MOV		A,DISC2RT_CNT2
	SUB		A,#02H
	BTS0	FC
	JMP		CHKP_DIS2RT2
	BTS1	CHKINP_B
	RET
CHKP_DIS2RT2:	
	INCMS	CHK_STEP
	NOP
	BSET	ADFINISH_B
	CLR		ADP_STEP
	BCLR	DIVFINISH_F
CHKP61:	
	CLR		CHARGE_CNT1
	CLR		CHARGE_CNT2	
	RET
CHKP4:
	CLR		CHK_STEP
	JMP		CHKP61
CHKP60:
	MOV		A,CHK_STEP
	XOR		A,#1
	BTS1	FZ
	JMP		CHKP61
	CLR		DISC2RT_CNT1
	CLR		DISC2RS_CNT
	CLR		DISC2RT_CNT2	
	JMP		CHKP61
;**************************
;  ORG  0X0C00		
;**************************	
;1.4MS L + 300US H == 0
;500US L + 1.2MS H == 1
;**************************	
IR_CHK:						;250US
        MOV     A,PULSE
        SUB     A,#09H             ;5
        BTS0	FC		;PULSE<5
        JMP     ERROR1		;>=A
        MOV		A,PULSE
;   	B0ADD	PCL,A    
	@JMP_A	9
   	JMP		 PE1
   	JMP		 PE2
   	JMP		 PE3
   	JMP		 PE4
   	JMP		 PE1
   	JMP		 PE2
   	JMP		 PE3
   	JMP		 PE4
	JMP		PE9   	
PE1:                            ;WAIT START 7MS HIGH
;        MOV     A,P0
        BTS1     IRIN_B
        JMP     PE010
        INCMS     H_CNT1
;        NOP
        MOV		A,H_CNT1
        SUB		A,#100/2
	BTS1	FC
        RET			;<
        MOV		A,#100
        MOV		H_CNT1,A
	BTS1	IRK_B       
	RET
	BCLR	IRK_B        
	CLR	DATAL2
	CLR	DATAH2
;	CLR	DATAL3
;	CLR	DATAH3
;	CLR	DATA_STEP
        RET
PE2:                            ;DATA LOW PAUSE 500US OR 1.4MS
;        MOV     A,P0
        BTS0    IRIN_B
        JMP     PE020
        INCMS     L_CNT1
 ;       NOP
        MOV	A,L_CNT1
        SUB	A,#20/2
        BTS1	FC
        RET			;<
        MOV	A,#20/2
        MOV	L_CNT1,A
        RET
PE3:                            ;HIGH DATA
;        MOV     A,P0
	BTS1	IRIN_B
        JMP     PE030
        INCMS     H_CNT1
;        NOP
        MOV	A,H_CNT1
        SUB	A,#20/2
        BTS1	FC		;JBC	STATUS,C
        RET			;<=
        MOV	A,#20/2
        MOV	H_CNT1,A
        RET
PE4:                            ;WAIT 400US OR 1.4MS LOW PAUSE
 ;       MOV     A,P0
        BTS0	IRIN_B
        JMP     PE040
        INCMS     L_CNT1
;        NOP
        MOV	A,L_CNT1
        SUB	A,#20/2
        BTS1	FC		
        RET			;<=
        MOV	A,#20/2
        MOV	L_CNT1,A        
        RET
PE9:                            ;7MS HIGH,END
;        MOV     A,P0
        BTS1	IRIN_B
        JMP     ERROR1		;PE050
        INCMS     H_CNT1
        NOP
        MOV	A,H_CNT1
        SUB	A,#40/2
        BTS1	FC		;
        RET			;<=
	JMP	PEA

PE010:                          ;7MS H
	BTS0	IRK_B        
		JMP	ERROR1		
		MOV	A,H_CNT1
		SUB	A,#95/2
		BTS0	FC		;
       JMP	ERROR1			;>=
        INCMS     PULSE
;        NOP
        CLR     L_CNT1
        CLR     H_CNT1
        INCMS     L_CNT1
        NOP
        MOV     A,#11
        MOV     B_CNT1,A
	CLR	DATAL
	CLR	DATAH
	CLR	DATALP_CNT
        RET
PE020:                          ;DATA PULSE L
        MOV     A,L_CNT1
        SUB     A,#1
        BTS1	FC		;JBC     STATUS,0        ;>
        JMP     ERROR1
        MOV     A,L_CNT1
        SUB     A,#14/2            ;
        BTS0	FC		;JBS     STATUS,0        ;<
        JMP     ERROR1
        MOV	A,L_CNT1
        MOV	DATALP_CNT,A
        CLR     L_CNT1
        CLR     H_CNT1
        INCMS     H_CNT1
 ;       NOP
        INCMS     PULSE
;        NOP
        RET
PE030:                          ;CHK DATA H
        MOV     A,H_CNT1
        SUB     A,#1
        BTS1	FC		;JBC     STATUS,0        ;>
        JMP     ERROR1           ;<=
        MOV     A,H_CNT1
        SUB     A,#6/2
        BTS1	FC		;JBC     STATUS,0        ;>5
        JMP     PE035           ;<=5
;        MOV     A,H_CNT1
 ;       SUB     A,#9/2
  ;      BTS1	FC		;JBC     STATUS,0        ;>
   ;     JMP	ERROR1
        MOV     A,H_CNT1
        SUB     A,#14/2
        BTS0	FC		;JBS     STATUS,0        ;<=
        JMP	ERROR1		;>16
PE036:				;H 8-16 ,CHK L
        MOV		A,DATALP_CNT
        SUB		A,#4		;5/2
        BTS0	FC		;JBS	STATUS,C 
        JMP	ERROR1
        BSET	HL_F	;AS "1"
        JMP	PE037
PE035:				;H 1-5 ,CHK L
        MOV		A,DATALP_CNT
        SUB		A,#3		;9/2
        BTS1	FC	;JBC	STATUS,C 
        JMP	ERROR1		;<=
        BCLR	HL_F	;AS "0"
        JMP	PE037
PE037:
	BSET	FC		;BS	STATUS,0
	BTS1	HL_F	;JBS	FLAG_HL.0	        
	BCLR	FC		;BC	STATUS,0
	RLCM	DATAL
	RLCM	DATAH   
        CLR     L_CNT1
        CLR     H_CNT1
        INCMS     L_CNT1
 ;       NOP        
	DECMS	B_CNT1		;DJZ	B_CNT1
	JMP	PE038
;	JMP	PE6	
        INCMS     PULSE
        NOP
	RET     
PE038:
	DECMS	PULSE		;CHK NEXT BIT
	NOP
	RET        

PE040:                          ;400US L
        MOV     A,L_CNT1
        SUB     A,#1
        BTS1	FC		;JBC     STATUS,0        ;
        JMP     ERROR1
        MOV     A,L_CNT1
        SUB     A,#8		;15/2            ;5
        BTS0	FC		;JBS     STATUS,0        ;<=
        JMP     ERROR1
        MOV	A,L_CNT1
        MOV	DATALP_CNT,A
        MOV	A,DATAL
        XOR	A,#0X3F
        BTS0	FZ
        JMP	PE043			;=
        MOV	A,DATAL
        XOR	A,#0X1E
        BTS0	FZ
        JMP	PE043			;=
        MOV	A,DATAL
        XOR	A,#0XBF
        BTS0	FZ
        JMP	PE043			;=
        MOV	A,DATAL
        XOR	A,#0X9E
        BTS0	FZ
        JMP	PE043			;=
        MOV	A,DATAL
        XOR	A,#0X7F
        BTS0	FZ
        JMP	PE043			;=
        MOV	A,DATAL
        XOR	A,#0X5E
        BTS0	FZ
        JMP	PE043			;=
        MOV	A,DATAL
        XOR	A,#0XFF
        BTS0	FZ
        JMP	PE043			;=
        MOV	A,DATAL
        XOR	A,#0XDE
        BTS1	FZ
        JMP	PE041			;/=                
PE043:
        MOV	A,DATALP_CNT
        SUB     A,#8/2           ;
        BTS1	FC
        JMP	ERROR1		;<
PE042:
        CLR     L_CNT1
        CLR     H_CNT1
        INCMS     H_CNT1
;        NOP
        INCMS     PULSE
;        NOP
	MOV	A,PULSE
	CMPRS	A,#4
	JMP	PE0421
 	MOV	A,DATAL
	MOV	DATAL2,A
	MOV	A,DATAH
	MOV	DATAH2,A
        RET
PE0421:
 	MOV	A,DATAL
	MOV	DATAL3,A
	MOV	A,DATAH
	MOV	DATAH3,A
        RET
PE041:
        MOV	A,DATALP_CNT
        SUB     A,#8/2           ;
        BTS0	FC
        JMP	ERROR1		;>
	JMP	PE042        
PEA:  
        CLR     L_CNT1
        CLR     H_CNT1
	CLR	PULSE
	BSET	FINISH_F
ERROR1:	
        CLR     L_CNT1
        CLR     H_CNT1
        CLR     PULSE
        RET
;**************************
;**************************	
BCD2HEXDP:
	MOV		A,HEXD
	MOV		DECD,A
	SWAP	HEXD
	AND		A,#0FH
	MOV		DATA_BUF,A
BCD2HEXDP1:
	MOV		A,DATA_BUF
	BTS0	FZ
	RET
	MOV		A,DECD
	SUB		A,#6
	MOV		DECD,A
	DECMS	DATA_BUF
	NOP
	JMP		BCD2HEXDP1
;**************************	
GET_TM:
/*	MOV		A,TM_STEP
	MOV		DATA_BUF,A
GET_TM1:
	BCLR	FC
	RRC		DATA_BUF
	MOV		TM_HOUR,A			;HOUR
	BTS0	TM_STEP.0
	JMP		GET_TM12
	MOV		A,TM_1HR
	BTS1	FZ
	JMP		GET_TM11
	CLR		TM_MIN			;MIN
	JMP		GET_TM2
GET_TM11:
	MOV		A,#60
	SUB		A,TM_1HR
	MOV		TM_MIN,A
	DECMS	TM_HOUR
	NOP	
	JMP		GET_TM2
GET_TM12:
	MOV		A,#30
	SUB		A,TM_1HR
	MOV		TM_MIN,A	
	*/
GET_TM2:					;HEX2BCD
	RET
;**************************
CHK_VR:
	MOV		A,VR_IN
	MOV		VR_OLD,A
	CLR		VR_IN
	BTS0	P1.4
	BSET	VR_IN.0
	BTS0	P1.3
	BSET		VR_IN.1
	MOV		A,VR_IN	
	CMPRS	A,VR_OLD
	JMP		CHK_VR2		;/=	
	RET					;=
CHK_VR2:			;/=
	MOV		A,VR_OLD
	CMPRS	A,#03H
	JMP		CHK_VR3		;/=
	MOV		A,VR_IN
	CMPRS	A,#02H	
	JMP		CHK_VR21
	JMP		CHK_VRSPUP		;FROM 03H->02H
CHK_VR21:
	MOV		A,VR_IN
	CMPRS	A,#01H	
	JMP		CHK_VRE
	JMP		CHK_VRSPDN		;FROM 03H->01H

CHK_VR3:			;/=
	MOV		A,VR_OLD
	CMPRS	A,#00H
	JMP		CHK_VRE		;/=
	MOV		A,VR_IN
	CMPRS	A,#02H	
	JMP		CHK_VR31
	JMP		CHK_VRSPDN	;FROM 00H->02H
CHK_VR31:
	MOV		A,VR_IN
	CMPRS	A,#01H	
	JMP		CHK_VRE
	JMP		CHK_VRSPUP	;FROM 00H->01H	
CHK_VRSPUP:
	CLR		VR_NOCHANGE_TM	
	CLR		VR_DN_CNT
	INCMS	VR_UP_CNT
	NOP
	MOV		A,VR_UP_CNT
	SUB		A,#1		;02
	BTS1	FC		;>=
	RET	
	CLR		VR_UP_CNT
	MOV		A,VR_TM
	SUB		A,#10			;20
	BTS1	FC
	RET
	CLR		VR_TM
	MOV		A,#02H
	MOV		VR_IN_F,A	;
	RET
CHK_VRSPDN:
	CLR		VR_NOCHANGE_TM		
	CLR		VR_UP_CNT
	INCMS	VR_DN_CNT
	NOP
	MOV		A,VR_DN_CNT
	SUB		A,#1		;02
	BTS1	FC		;>=
	RET	
	CLR		VR_DN_CNT
	MOV		A,VR_TM
	SUB		A,#10			;20
	BTS1	FC
	RET
	CLR		VR_TM
	MOV		A,#01H
	MOV		VR_IN_F,A	;
	RET
CHK_VRE:
	RET	
;**************************	
;**********************************
VR_SPK:	
	BTS0	ONF_F
	JMP		VR_SPK1
	BTS0	TM2ONE0_F
	JMP		VR_SPK1
	CLR		VR_IN_F
	RET
VR_SPK1:
	MOV		A,VR_IN_F
	CMPRS	A,#01H
	JMP		VR_SPK2
	CLR		VR_IN_F
	BSET	VRSPIN_F
	JMP		KEYP_SPDNK1			;IRP_SPUPK	;KEYP_SPUPK
VR_SPK2:
	MOV		A,VR_IN_F
	CMPRS	A,#02H
	RET
	CLR		VR_IN_F
	BSET	VRSPIN_F
	JMP		KEYP_SPUPK	;KEYP_SPDNK
	
KEYP_SPUPK:
	BCLR	VRSPIN_F
KEYP_SPUPK1:	
	BTS0	DPOFF_F
	JMP	KEYP_DPONP
	BTS0	TM2ONE0_F
	JMP	KEYP_SPUPK01
	BTS1	ONF_F
	RET
KEYP_SPUPK01:	
	MOV	A,MODE
	SUB	A,#3
	BTS0	FC
	RET
	CLR	DP_TM
	MOV	A,DP_MODE
	XOR	A,#0
	BTS0	FZ
	JMP	KEYP_SPUPK02
	MOV	A,#0
	MOV	DP_MODE,A
	JMP		KEYP_BZPM1	
KEYP_SPUPK02:	
	MOV		A,MODE
	BTS1	FZ
	JMP		KEYP_SPUPK_NATP
	MOV		A,SPEED
	SUB		A,#23
	BTS0	FC
	RET
	INCMS	SPEED
	NOP
	JMP		KEYP_BZPM1
KEYP_SPUPK_NATP:	
	MOV		A,NATURE_SPEED
	SUB		A,#4
	BTS0	FC
	RET
	INCMS	NATURE_SPEED
	NOP
KEYP_SPUPK_NATP0:	
	CALL	NATURE_INIT1
	JMP		KEYP_BZPM1
KEYP_SPDNK:
	BCLR	VRSPIN_F
KEYP_SPDNK1:	
	BTS0	DPOFF_F
	JMP	KEYP_DPONP
	BTS0	TM2ONE0_F
	JMP	KEYP_SPDNK01
	BTS1	ONF_F
	RET
KEYP_SPDNK01:	
	MOV	A,MODE
	SUB	A,#3
	BTS0	FC
	RET
	CLR	DP_TM
	MOV	A,DP_MODE
	XOR	A,#0
	BTS0	FZ
	JMP	KEYP_SPDNK02
	MOV	A,#0
	MOV	DP_MODE,A
	JMP		KEYP_BZPM1	
KEYP_SPDNK02:	
	MOV		A,MODE
	BTS1	FZ
	JMP		KEYP_SPDNK_NATP
	MOV		A,SPEED
	SUB		A,#1
	BTS1	FC
	RET
	DECMS	SPEED
	NOP
	JMP		KEYP_BZPM1
KEYP_SPDNK_NATP:	
	MOV		A,NATURE_SPEED
	SUB		A,#1
	BTS1	FC
	RET
	DECMS	NATURE_SPEED
	NOP
	JMP	KEYP_SPUPK_NATP0	
	
;**************************
VR_TMP:
	INCMS	VR_TM
	NOP
	MOV	A,VR_TM
	SUB	A,#20
	BTS1	FC
	JMP	VR_TMP1		;<
	MOV	A,#20
	MOV	VR_TM,A
VR_TMP1:
	INCMS	VR_NOCHANGE_TM
	NOP
	MOV	A,VR_NOCHANGE_TM
	SUB	A,#50
	BTS1	FC
	JMP	VR_TMP2		;<
	CLR	VR_NOCHANGE_TM
    CLR	VR_UP_CNT
    CLR	VR_DN_CNT
VR_TMP2:
	RET          	
;**************************	
  ORG  0X0FF8                             ;			
    JMP    START                        ;			
;**************************	
	